---------
Posgresql
---------






----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


CREATE DATABASE hrdb;		            --- create database
DROP DATABASE <database_name>;	    --- delete database



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


$ psql.exe -U postgres ( for Win ) --- start postgresql command line
$ psql \! chcp 1251 ( for Win )    --- change coding
$ sudo -u postgres psql            --- start postgresql command line
$ \list                            --- database list
$ \c database_name                 --- connect to database
$ \d                               --- tables list
$ select * from table;             --- select row
$ \x                               --- view mode for large tables20/02/2022 11:04:25 



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Create new user cmd's
---------------------


$ sudo -u postgres psql
$ postgres=# create database mydb;
$ postgres=# create user gor with encrypted password '1';
$ postgres=# grant all privileges on database mydb to gor; 



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Edit pg_hba.conf
----------------

$ sudo -u postgres psql
postgres-# SHOW hba-file

$ sudo su postgres
$ whoami
$ vi pg_hba.conf



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Restart Postgresql
------------------

$ sudo service postgresql restart



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Общие
-----


\copyright             	--- условия использования и распространения PostgreSQL
\crosstabview[СТОЛБЦЫ] 	--- выполнить запрос и вывести результат в перекрёстном виде
\errverbose            	--- вывести максимально подробное сообщение о последней ошибке
\g [ФАЙЛ] или ;        	--- выполнить запрос (и направить результаты в файл или канал |)
\gdesc                 	--- описать результат запроса, но не выполнять его
\gexec                 	--- выполнить запрос, а затем выполнить каждую строку в результате
\gset [ПРЕФИКС]        	--- выполнить запрос и сохранить результаты в переменных psql
\gx [ФАЙЛ]             	--- то же, что и \g, но в режиме развёрнутого вывода
\q                     	--- выйти из psql
\watch [СЕК]           	--- повторять запрос в цикле через заданное число секунд



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Справка
-------


\? [commands]          	--- справка по командам psql c \
\? options             	--- справка по параметрам командной строки psql
\? variables           	--- справка по специальным переменным
\h [ИМЯ]               	--- справка по заданному SQL-оператору; * - по всем



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Буфер запроса
-------------


\e [ФАЙЛ] [СТРОКА]     	--- править буфер запроса (или файл) во внешнем редакторе
\ef [ФУНКЦИЯ [СТРОКА]] 	--- править определение функции во внешнем редакторе
\ev [VIEWNAME [LINE]]  	--- править определение представления во внешнем редакторе
\p                     	--- вывести содержимое буфера запросов
\r                     	--- очистить буфер запроса
\w ФАЙЛ                	--- записать буфер запроса в файл



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Ввод/Вывод
----------


\copy ...              	--- выполнить SQL COPY на стороне клиента
\echo [СТРОКА]         	--- записать строку в стандартный вывод
\i ФАЙЛ                	--- выполнить команды из файла
\ir ФАЙЛ               	--- подобно \i, но путь задаётся относительнотекущего скрипта
\o [ФАЙЛ]              	--- выводить все результаты запросов в файл или канал |
\qecho [СТРОКА]        	--- записать строку в поток результатов запроса (см. \o)



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Условия
-------


\if ВЫРАЖЕНИЕ          	--- начало блока условия
\elif ВЫРАЖЕНИЕ        	--- альтернативная ветвь в текущем блоке условия
\else                  	--- окончательная ветвь в текущем блоке условия
\endif                 	--- конец блока условия



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Информационные (дополнения: S = показывать системные объекты, + = дополнительные подробности)
---------------------------------------------------------------------------------------------


\d[S+]                 	--- список таблиц, представлений и последовательностей
\d[S+]  ИМЯ            	--- описание таблицы, представления, последовательности или индекса
\da[S]  [МАСКА]        	--- список агрегатных функций
\dA[+]  [МАСКА]        	--- список методов доступа
\db[+]  [МАСКА]        	--- список табличных пространств
\dc[S+] [МАСКА]        	--- список преобразований
\dC[+]  [МАСКА]        	--- список приведений типов
\dd[S]  [МАСКА]        	--- описания объектов, не выводимые в других режимах
\dD[S+] [МАСКА]        	--- список доменов
\ddp    [МАСКА]        	--- список прав по умолчанию
\dE[S+] [МАСКА]        	--- список сторонних таблиц
\det[+] [МАСКА]        	--- список сторонних таблиц
\des[+] [МАСКА]        	--- список сторонних серверов
\deu[+] [МАСКА]        	--- список сопоставлений пользователей
\dew[+] [МАСКА]        	--- список обёрток сторонних данных
\df[anptw][S+] [МАСКА] 	--- список [только агрегатных/обычных/(процедур) / триггерных/оконных] функций
\dF[+]  [МАСКА]        	--- список конфигураций текстового поиска
\dFd[+] [МАСКА]        	--- список словарей текстового поиска
\dFp[+] [МАСКА]        	--- список анализаторов текстового поиска
\dFt[+] [МАСКА]        	--- список шаблонов текстового поиска
\dg[S+] [МАСКА]        	--- список ролей
\di[S+] [МАСКА]        	--- список индексов
\dl                    	--- список больших объектов (то же, что и \lo_list)
\dL[S+] [МАСКА]        	--- список языков процедур
\dm[S+] [МАСКА]        	--- список материализованных представлений
\dn[S+] [МАСКА]        	--- список схем
\do[S]  [МАСКА]        	--- список операторов
\dO[S+] [МАСКА]        	--- список правил сортировки
\dp     [МАСКА]        	--- список прав доступа к таблицам, представлениям и последовательностям
\dP[itn+] [МАСКА]      	--- список секционированных отношений [только индексов (i)/таблиц (t)], с вложенностью (n)
\drds [МАСК1 [МАСК2]]  	--- список параметров роли на уровне БД
\dRp[+] [МАСКА]        	--- список публикаций для репликации
\dRs[+] [МАСКА]        	--- список подписок на репликацию
\ds[S+] [МАСКА]        	--- список последовательностей
\dt[S+] [МАСКА]        	--- список таблиц
\dT[S+] [МАСКА]        	--- список типов данных
\du[S+] [МАСКА]        	--- список ролей
\dv[S+] [МАСКА]        	--- список представлений
\dx[+]  [МАСКА]        	--- список расширений
\dy     [МАСКА]        	--- список событийных триггеров
\l[+]   [МАСКА]        	--- список баз данных
\sf[+]  ИМЯ_ФУНКЦИИ    	--- показать определение функции
\sv[+]  ИМЯ_ПРЕДСТ     	--- показать определение представления
\z      [МАСКА]        	--- то же, что и \dp



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Форматирование
--------------


\a                     	--- переключение режимов вывода: неформатированный/выровненный
\C [СТРОКА]            	--- задать заголовок таблицы или убрать, если не задан
\f [СТРОКА]            	--- показать или установить разделитель полей для неформатированного вывода
\H                     	--- переключить режим вывода в HTML (текущий: выкл.)
\t [on|off]            	--- режим вывода только строк (сейчас: выкл.)
\T [СТРОКА]            	--- задать атрибуты для <table> или убрать, если не заданы
\x [on|off|auto]       	--- переключить режим расширенного вывода (сейчас: выкл.)
\pset [ИМЯ [ЗНАЧЕНИЕ]] 	--- установить параметр вывода таблицы


(
  border
  columns
  csv_fieldsep
  expanded
  fieldsep
  fieldsep_zero
  footer
  format
  linestyle
  null
  numericlocale
  pager
  pager_min_lines
  recordsep
  recordsep_zero
  tableattr
  title
  tuples_only
  unicode_border_linestyle
  unicode_column_linestyle
  unicode_header_linestyle
)



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Соединение
----------


\c БД				            --- connect to db
\conninfo              	--- информация о текущем соединении
\encoding [КОДИРОВКА]  	--- показать/установить клиентскую кодировку
\password [ИМЯ]        	--- безопасно сменить пароль пользователя



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Операционная система
--------------------


\cd [ПУТЬ]             	--- сменить текущий каталог
\setenv ИМЯ [ЗНАЧЕНИЕ] 	--- установить или сбросить переменную окружения
\timing [on|off]       	--- включить/выключить секундомер (сейчас: выкл.)
\! [КОМАНДА]           	--- выполнить команду в командной оболочке или запустить интерактивную оболочку



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Переменные
----------


\prompt [ТЕКСТ] ИМЯ    	--- предложить пользователю задать внутреннюю переменную
\set [ИМЯ [ЗНАЧЕНИЕ]]  	--- установить внутреннюю переменную или вывести все, если имя не задано
\unset ИМЯ             	--- сбросить (удалить) внутреннюю переменную



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Большие объекты
---------------


\lo_export LOBOID ФАЙЛ
\lo_import ФАЙЛ [КОММЕНТАРИЙ]
\lo_list
\lo_unlink LOBOID      	--- операции с большими объектами



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

pgAdmin4
--------



-------- On Linux Mint 20 --------
$ sudo nano pgadmin4env/lib/python3.8/site-packages/pgadmin4/config_local.py

-------- On Linux Mint 21 --------
$ sudo nano pgadmin4env/lib/python3.10/site-packages/pgadmin4/config_local.py


import os
DATA_DIR = os.path.realpath(os.path.expanduser(u'~/.pgadmin/'))
LOG_FILE = os.path.join(DATA_DIR, 'pgadmin4.log')
SQLITE_PATH = os.path.join(DATA_DIR, 'pgadmin4.db')
SESSION_DB_PATH = os.path.join(DATA_DIR, 'sessions')
STORAGE_DIR = os.path.join(DATA_DIR, 'storage')
SERVER_MODE = False
AZURE_CREDENTIAL_CACHE_DIR = os.path.join(DATA_DIR, 'azurecredentialcache')





----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


https://www.postgresqltutorial.com/postgresql-cheat-sheet/



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------









----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Основные принципы оптимизации PostgreSQL

    Правильные индексы — ускоряют SELECT, но замедляют INSERT/UPDATE.

    Нормализация + денормализация — баланс для скорости чтения и записи.

    EXPLAIN / EXPLAIN ANALYZE — анализ планов запросов.

    VACUUM и ANALYZE — регулярная очистка и обновление статистики.

    Настройка параметров PostgreSQL (work_mem, shared_buffers, etc.).

2. Команды анализа и диагностики
EXPLAIN и ANALYZE

EXPLAIN SELECT * FROM users WHERE email = 'test@example.com';
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';

    EXPLAIN — показывает план запроса.

    ANALYZE — выполняет запрос и показывает фактическое время.

Просмотр текущих запросов

SELECT * FROM pg_stat_activity;

Статистика использования индексов

SELECT relname, idx_scan, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes JOIN pg_class ON pg_class.oid=pg_stat_user_indexes.relid;

Текущие блокировки

SELECT * FROM pg_locks;

3. Индексы
Создание индексов

CREATE INDEX index_users_on_email ON users (email);

Уникальный индекс

CREATE UNIQUE INDEX index_users_on_email ON users (email);

Составной индекс

CREATE INDEX index_users_on_name_and_age ON users (name, age);

GIN / GiST индексы (для JSONB и полнотекстового поиска)

CREATE INDEX index_users_on_data_jsonb ON users USING gin (data);

Полнотекстовый поиск

CREATE INDEX index_articles_on_content_tsvector
ON articles USING GIN (to_tsvector('english', content));

4. VACUUM и ANALYZE
Очистка мусора и статистика

VACUUM;
ANALYZE;

Полная очистка

VACUUM FULL;

Автоматизация: Включай autovacuum в настройках PostgreSQL.
5. Оптимизация конфигурации PostgreSQL (postgresql.conf)

    shared_buffers: ~25% от RAM сервера.

    work_mem: 4-16 MB (на соединение).

    effective_cache_size: ~75% от RAM.

    wal_buffers: 16MB (или больше для больших транзакций).

    checkpoint_completion_target: 0.7–0.9.

6. Лучшие практики запросов

    SELECT только нужные поля (избегай SELECT *).

    Используй LIMIT и OFFSET для пагинации.

    Сложные JOIN заменяй на простые запросы + кэширование.

    WHERE vs. LIKE:

        LIKE 'abc%' — использует индекс.

        LIKE '%abc%' — не использует индекс (создай GIN).

    Используй EXISTS вместо IN, если список большой.

7. Оптимизация ActiveRecord (Rails)

    Используй select и pluck:

User.select(:id, :email)
User.pluck(:email)

Жадная загрузка (includes) для N+1:

Post.includes(:comments).each { |p| p.comments }

Анализ запросов:

    rails db:explain "Post.includes(:comments).to_sql"

8. Миграции и индексы (Rails)
Добавление индекса:

rails g migration add_index_to_users_email

add_index :users, :email

Составной индекс:

add_index :users, [:name, :age]

Уникальный индекс:

add_index :users, :email, unique: true

9. Мониторинг и профилирование

    pg_stat_statements (расширение):

CREATE EXTENSION pg_stat_statements;
SELECT * FROM pg_stat_statements ORDER BY total_exec_time DESC LIMIT 10;

Проверка фрагментации таблиц:

    SELECT relname, n_dead_tup FROM pg_stat_user_tables WHERE n_dead_tup > 0;

10. Полезные команды

-- Список таблиц
\dt

-- Список индексов
\di

-- Статистика по таблице
\d+ users

11. Автоматическая оптимизация

    pg_repack — удаляет фрагментацию без VACUUM FULL.

    PgHero (gem):

    gem 'pghero'

    Запуск панели: /pghero.

12. Best Practices

    Индексируй часто используемые WHERE и JOIN ключи.

    Не создавай слишком много индексов — они замедляют запись.

    Запускай ANALYZE после крупных обновлений данных.

    Кэшируй запросы с помощью Rails.cache или Materialized Views.













































